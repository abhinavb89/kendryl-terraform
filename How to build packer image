#install packer
choco install packer
###create the resource group using az command
az group create -n packgerimagegroup -l east us
####also change the clientid client secret subscriptionid and tenantid
####create a file ubuntu.pkr.hcl
###inside the file put this content
source "azure-arm" "autogenerated-1" {
    azure_tags = {
        dept = "IT"
        task = "image deployment"
    }
    client_id = "12c0db5b-d8ec-4d6b-b79b-6c5d5fa8153b"
    client_secret = "SnG8Q~VHHrntQixG1s_B8owWqgIDIelykW31wdmw"
    image_offer = "0001-com-ubuntu-server-focal"
    image_publisher = "Canonical"
    image_sku = "20_04-lts"
    location = "eastus"
    managed_image_name = "mygoldenpackerimage"
    managed_image_resource_group_name = "packgerimagegroup"
    os_type = "Linux"
    subscription_id = "96b933ba-3ac8-4a40-99cd-89bd68a4e6d6"
    tenant_id = "961e4a55-c338-498d-a310-544a2b8c027e"
    vm_size = "Standard_DS2_v2"
}
    build {
        sources = ["source.azure-arm.autogenerated-1"]
    
    provisioner "shell" {
    execute_command = "chmod +x {{ .Path }}; {{ .Vars }} sudo -E sh '{{ .Path }}'"
    inline          = ["apt-get update", "apt-get upgrade -y", "apt-get -y install nginx", "/usr/sbin/waagent -force -deprovision+user && export HISTSIZE=0 && sync"]
    inline_shebang  = "/bin/sh -x"
  }
}

#####execute the file
packer build ubuntu.pkr.hcl
##launch a vm using packer image
14 az vm create --resource-group packgerimagegroup --name myVM --image mygoldenpackerimage --admin-username azureuser --admin-password=Admin@12345678 
  17 az vm open-port --resource-group packgerimagegroup --name myVM --priority 102 --port 22
  17 az vm open-port --resource-group packgerimagegroup --name myVM --priority 103 --port 80

